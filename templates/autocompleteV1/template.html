<%
    var inputSelector = '#persoo--' + offerID + ' .persoo-ac-search-bar__input';
    var formSelector = '#persoo--' + offerID + ' .persoo-ac-search-bar__form';
    var dropdownSelector = '#persoo--' + offerID + ' .persoo-ac-search-bar__dropdown';
%>
<div id="persoo--<%= offerID %>">
    <style type="text/css">
        <%= customCSS %>
    </style>

    <%= searchBarTemplate %>
    <% if (inputSelector && formSelector) { %>
        <script>
            var formNode = document.querySelector('<%= formSelector %>');

            formNode.onsubmit = function() {
                var query = document.querySelector('<%= inputSelector %>').value;
                console.log("You searched for query '" + query + "'");
                document.location.href = '<%= searchLink %>'.replace(/\$query/g, query);
                return false;
            };
        </script>
    <% } %>

    <script>
        var persoo_<%= offerID %> = (function () {
            function initAutocomplete() {
                var myAutocomplete = new PersooAutocomplete('<%= inputSelector %>', '<%= dropdownSelector %>', {
                    autocompleteID: "persooAutocompleteDropdown",
                    datasets: [
                        <% if (datasetsCount >= 2) { %>
                            {
                                id: "2",
                                source: window.persoo.getAlgorithmSource('<%= dataset2Algorithm %>', <%= dataset2MaxResultsCount %>),
                                showWhenEmptyResults: <%= dataset1ShowWhenEmptyResults %>,
                                <%
                                   var templates2 = {};
                                   if (dataset2HeaderTemplate) {
                                       templates2.header = dataset2HeaderTemplate;
                                   }
                                   if (dataset2ItemTemplate) {
                                       templates2.item = dataset2ItemTemplate;
                                   }
                                   if (dataset2FooterTemplate) {
                                       templates2.footer = dataset2FooterTemplate;
                                   }
                                   if (dataset2EmptyTemplate) {
                                       templates2.empty = dataset2EmptyTemplate;
                                   }
                                %>
                                templates: <%= JSON.stringify(templates2) %>,
                                classNames: <%= JSON.stringify(customClassNamesJSON.dataset2 || {}) %>
                            },
                        <% } %>
                        {
                            id: "1",
                            source: window.persoo.getAlgorithmSource('<%= dataset1Algorithm %>', <%= dataset1MaxResultsCount %>),
                            showWhenEmptyResults: <%= dataset1ShowWhenEmptyResults %>,
                            <%
                                var templates1 = {};
                                if (dataset1HeaderTemplate) {
                                    templates1.header = dataset1HeaderTemplate;
                                }
                                if (dataset1ItemTemplate) {
                                    templates1.item = dataset1ItemTemplate;
                                }
                                if (dataset1FooterTemplate) {
                                    templates1.footer = dataset1FooterTemplate;
                                }
                                if (dataset1EmptyTemplate) {
                                    templates1.empty = dataset1EmptyTemplate;
                                }
                            %>
                            templates: <%= JSON.stringify(templates1) %>,
                            classNames: <%= JSON.stringify(customClassNamesJSON.dataset1 || {}) %>
                        },
                    ],
                    minChars: <%= minChars %>,
                    requestThrottlingInMs: <%= requestThrottlingInMs %>,
                    openOnFocus: <%= openOnFocus %>,
                    closeOnBlur: <%= closeOnBlur %>,
                    classNames: <%= JSON.stringify(customClassNamesJSON.dropdown || {}) %>,
                        offsetLeft: null,
                        offsetTop: null,
                        width: null,
                        onRender: function(state) {
                            <% if (formSelector) { %>
                                var formClassName = formNode.className;
                                var formVisibleClassName = ' persoo-ac-search-bar__form--visible';
                                var hasFormVisibleClassName = formClassName.match(formVisibleClassName) !== null;

                                if (state.isVisible) {
                                    formClassName = hasFormVisibleClassName ?
                                        formClassName :
                                    	formClassName + formVisibleClassName;
                                } else {
                                    formClassName = hasFormVisibleClassName ?
                                        formClassName.replace(formVisibleClassName, '') :
                                    	formClassName;
                                }

                                formNode.className = formClassName;
                            <% } %>
                        }
                });
            }
            function loadScript(url, onloadFn, errorFn) {var d = document; var s=d.createElement("script");
                s.src=url,s.type="text/javascript",s.async=true,s.onerror=errorFn,s.onload=onloadFn;
                d.getElementsByTagName("head")[0].appendChild(s)};

            var acLibLink = "https://scripts.persoo.cz/shared/autocompleteV2.4/persooAutocomplete.js";
            loadScript(acLibLink, initAutocomplete, function (){});
        })();
    </script>
    <script type="text/javascript">
        <%= customJS %>
    </script>
</div>
