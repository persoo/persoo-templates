
<%
    var offerID = offerID || 'randomOfferID';
    var priceSufix = '&nbsp;Kč';

    function printTemplateFunctionsAsJSON(templates) {
        var html = "{";
        for (var key in templates) {
            if (html != "{") {
                 html += ',';
            }
            var templateFunction = templates[key];
            if (typeof templateFunction == 'function') {
                templateFunction = templateFunction.toString();
            }
            html += key + ": " + templateFunction;
        }
        return html + "}";
    }

    function renderTemplateFunction(pattern) {
        return (function (data) {
            return "$pattern".replace(/\$query/g, data.query).replace(/\$count/g, data.count);
        }).toString().replace(/\$pattern/, pattern);
    };
    function renderTemplateFunctionIfNonEmpty(pattern) {
        return (function (data) {
            if (data.isEmpty) {
                return "";
            } else {
                return "$pattern".replace(/\$query/g, data.query).replace(/\$count/g, data.count);
            }
        }).toString().replace(/\$pattern/, pattern);
    };
%>
<div>
    <%
       /* prerequisities to see something in the preview */
       var debug = false;
       if (debug) {
    %>
    <script type="text/javascript">
          /* delete preview mock and load real persoo.js */
          delete window.persoo;

          /* Persoo account for testing real requests */
          dataLayer = [{
              pageType: 'search'
          }];
          var persooConfig = {
              apikey: '41kifbkoqit4dcr6c7do9h3f',
              persooName: 'persoo',
              dataLayerName: 'dataLayer',
              settings_tolerance: 2000,  // for loading persoo.js
              personalizations_tolerance: 2500,    // for showing personalizations
              rtpProtocol: 'http:'
          };
          /*! Persoo js client 2015-03-16 */
          var persooLoader=function(a,b,c,d,e){var f=d.persooName,g="_persoo_hide_body";return{hideBody:
          function(){var b=a.createElement("style"),c="body{opacity:0 !important;filter:alpha(opacity=0)"
          +" !important;background:none !important;}",d=a.getElementsByTagName("head")[0];b.setAttribute(
          "id",g),b.setAttribute("type","text/css"),b.styleSheet?b.styleSheet.cssText=c:b.appendChild(
          a.createTextNode(c)),d.appendChild(b)},finish:function(){if(!c){c=!0;var b=a.getElementById(g);b&&
          b.parentNode.removeChild(b)}},loadScript:function(b){var c=a.createElement("script");c.src=b,c.type
          ="text/javascript",c.onerror=function(){persooLoader.finish()},a.getElementsByTagName("head")[0
          ].appendChild(c)},init:function(){b[f]=b[f]||function(){(b[f].q=b[f].q||[]).push([].slice.call(
          arguments))},b[f].l=1*new Date,b[f].apikey=d.apikey,b[f].dataLayerName=d.dataLayerName;var c=
          a.cookie.match("(^|; )"+e+"=([^;]*)"),g=location.search.match("[?&]"+e+"=([^&]*)"),h=g?g[1]:c?c[2]:
          "p";d.settings_tolerance>0&&(setTimeout(this.finish,d.settings_tolerance),this.hideBody());var i=(
          d.scriptsHostname||"//scripts.persoo.cz/")+d.apikey+"/"+h;this.loadScript(i+"/actions.js"),
          this.loadScript(i+"/persoo.js")}}}(document,window,!1,persooConfig,"persooEnvironment");persooLoader.init();
    </script>

    <% } %>
    <% /* real template source code */ %>

    <style type="text/css">
        <%= customCSS %>
    </style>

    <%= searchBarTemplate %>
    <% if (inputSelector && formSelector) { %>
        <script>
            document.querySelector('<%= formSelector %>').onsubmit = function() {
                var query = document.querySelector('<%= inputSelector %>').value;
                console.log("You searched for query '" + query + "'");
                document.location.href = '<%= searchLink %>'.replace(/\$query/g, query);
                return false;
            };
        </script>
    <% } %>

    <script>
        var persoo_<%= offerID %> = (function () {
            function initAutocomplete() {
                var myAutocomplete = new PersooAutocomplete('<%= inputSelector %>', {
                    autocompleteID: "<%= autocompleteID %>",
                    datasets: [
                        <% if (datasetsCount >= 2) { %>
                            {
                                id: "2",
                                source: window.persoo.getAlgorithmSource('<%= dataset2Algorithm %>', <%= dataset2MaxResultsCount %>),
                                showWhenEmptyResults: <%= dataset1ShowWhenEmptyResults %>,
                                <%
                                   var templates2 = {};
                                   if (dataset2HeaderTemplate) {
                                       templates2.header = renderTemplateFunction(dataset2HeaderTemplate);
                                   }
                                   if (dataset2HitTemplate) {
                                       templates2.hit = dataset2HitTemplate;
                                   }
                                   if (dataset2FooterTemplate) {
                                       templates2.footer = renderTemplateFunctionIfNonEmpty(dataset2FooterTemplate);
                                   }
                                   if (dataset2EmptyTemplate) {
                                       templates2.empty = renderTemplateFunction(dataset2EmptyTemplate);
                                   }
                                %>
                                templates: <%= printTemplateFunctionsAsJSON(templates2) %>
                            },
                        <% } %>
                        {
                            id: "1",
                            source: window.persoo.getAlgorithmSource('<%= dataset1Algorithm %>', <%= dataset1MaxResultsCount %>),
                            showWhenEmptyResults: <%= dataset1ShowWhenEmptyResults %>,
                            <%
                            var templates1 = {};
                            if (dataset1HeaderTemplate) {
                                templates1.header = renderTemplateFunction(dataset1HeaderTemplate);
                            }
                            if (dataset1HitTemplate) {
                                templates1.hit = dataset1HitTemplate;
                            }
                            if (dataset1FooterTemplate) {
                                templates1.footer = renderTemplateFunctionIfNonEmpty(dataset1FooterTemplate);
                            }
                            if (dataset1EmptyTemplate) {
                                templates1.empty = renderTemplateFunction(dataset1EmptyTemplate);
                            }
                            %>
                            templates: <%= printTemplateFunctionsAsJSON(templates1) %>
                        },
                    ],
                    minChars: <%= minChars %>,
                    requestThrottlingInMs: <%= requestThrottlingInMs %>,
                    openOnFocus: <%= openOnFocus %>,
                    closeOnBlur: <%= closeOnBlur %>,
                    offsetLeft: <%= offsetLeft %>,
                    offsetTop: <%= offsetTop %>,
                    width: <%= useInputWidth == true ? '"input"' : 'null' %>,
                    priceSuffix: "<%= priceSufix.replace("&nbsp;", "\u00A0") %>"
                });
            }
            function loadScript(url, onloadFn, errorFn) {var d = document; var s=d.createElement("script");
                s.src=url,s.type="text/javascript",s.async=true,s.onerror=errorFn,s.onload=onloadFn;
                d.getElementsByTagName("head")[0].appendChild(s)};

            var acLibLink = "https://scripts.persoo.cz/shared/autocompleteV2.1/persooAutocomplete.js";
            loadScript(acLibLink, initAutocomplete, function (){});
        })();
    </script>
    <script type="text/javascript">
        <%= customJS %>
    </script>
</div>
