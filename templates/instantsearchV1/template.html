<div id="persoo--<%= offerID %>">
    <style type="text/css">
        <%= customCSS %>
    </style>

    <%= layoutHTML %>

    <% if (showFulltextFilter) { %>
        <div id="persoo-sb-template-<%= offerID %>" style="display:none;">
            <%= searchBarHTML %>
        </div>
        <script>
            (function () {
                var containerElem = document.querySelector('<%= widgetContainerSelectors.searchBar %>');
                if (containerElem) {
                    var contentElem = document.getElementById('persoo-sb-template-<%= offerID %>');
                    containerElem.innerHTML = contentElem.innerHTML;
                } else {
                    console.warn('Persoo Search Results: external search bar selector ' +
                    '"<%= widgetContainerSelectors.searchBar %>" does not match any element in page.');
                }
            })();
        </script>
    <% } %>

    <script>
        var persoo_<%= offerID %> = (function () {
            function initInstantSearch() {
                var search = persooInstantSearch({
                    algorithmID: "<%= searchAlgorithm %>",
                    urlSync: <%= urlSync %>
                });
                <%
                function addTemplate(templateField) {
                    return 'persooInstantSearch.EJS(' + JSON.stringify(templateField) + ')';
                }
                function addClassNamesFor(widget, defaults) {
                    var cssClasses = defaults;
                    var userClasses = customClassNamesJSON[widget];
                    if (userClasses) {
                        for (var i in userClasses) {
                            cssClasses[i] = (cssClasses[i] ? cssClasses[i] + ' ' : '') + userClasses[i];
                        }
                    }
                    return JSON.stringify(cssClasses);
                }
                function addCollapsibleOption(collapsible, collapsed) {
                    if (collapsible) {
                        return 'collapsible: { collapsed: ' + !!collapsed + '}';
                    } else {
                        return 'collapsible: false';
                    }
                }
                function addShowMoreOption(showMore, limit) {
                    if (showMore) {
                        var opt = {
                            limit: limit,
                            templates: {
                                active: "ACTIVE",
                                inactive: "INACTIVE"
                            }
                        }
                        return 'showMore: ' + JSON.stringify(opt)
                            .replace('"ACTIVE"', addTemplate(
                                '<div class="persoo-show-more persoo-show-more__active">' + showMoreActiveTemplate + '</div>'))
                            .replace('"INACTIVE"', addTemplate(
                                '<div class="persoo-show-more persoo-show-more__inactive">' + showMoreInactiveTemplate + '</div>'));
                    } else {
                        return 'showMore: false';
                    }
                }
                %>

                search.addWidget(
                    persooInstantSearch.widgets.<%= (paginationType == 'infiniteItems' ? 'infiniteHits' : 'hits') %>({
                        container: '<%= widgetContainerSelectors.items %>',
                        hitsPerPage: <%= itemsPerPage %>,
                        <%= paginationType == 'infiniteItems' ? 'showMoreLabel: "' + showMoreHitsLabel + '",' : '' %>
                        templates: {
                            item: <%= addTemplate(itemTemplate) %>,
                            empty: <%= addTemplate(emptyResultsTemplate) %>
                        },
                        cssClasses: <%= addClassNamesFor(paginationType == 'infiniteItems' ? 'infiniteHits' : 'hits', {}) %>
                    })
                );
                <% if (paginationType == 'pagination') { %>
                    search.addWidget(
                        persooInstantSearch.widgets.pagination({
                            container: '<%= widgetContainerSelectors.pagination %>',
                            cssClasses: <%= addClassNamesFor('pagination', {}) %>
                        })
                    );
                    <% if (showItemsPerPage) { %>
                        search.addWidget(
                            persooInstantSearch.widgets.hitsPerPageSelector({
                                container: '<%= widgetContainerSelectors.itemsPerPage %>',
                                <%
                                    var itemsPerPageAsList = itemsPerPageValues.split(/\s*,\s*/);
                                    var itemsPersPageOptions = JSON.stringify(itemsPerPageAsList.map(function (item){
                                        return {
                                                value: item,
                                                label: item + itemsPerPageSuffixTemplate
                                        };
                                    }))
                                %>
                                autoHideContainer: true,
                                options: <%= itemsPersPageOptions %>,  // default is defined in hits widget
                                cssClasses: <%= addClassNamesFor('hitsPerPageSelector', {}) %>
                            })
                        );
                    <% } %>
                <% } %>
                <% if (showStats) { %>
                    search.addWidget(
                        persooInstantSearch.widgets.stats({
                            container: '<%= widgetContainerSelectors.stats %>',
                            templates: {
                                body: <%= addTemplate(statsTemplate) %>
                            },
                            cssClasses: <%= addClassNamesFor('stats', {}) %>
                        })
                    );
                <% } %>

                <% if (showClearAll) { %>
                    search.addWidget(
                        persooInstantSearch.widgets.clearAll({
                            container: '<%= widgetContainerSelectors.clearAll %>',
                            templates: {
                                link: 'Reset everything but fulltext'
                            },
                            cssClasses: <%= addClassNamesFor('clearAll', {}) %>,
                            autoHideContainer: false
                        })
                    );
                <% } %>
                <% if (showCurrentRefinedValues) { %>
                    search.addWidget(
                        persooInstantSearch.widgets.currentRefinedValues({
                            container: '<%= widgetContainerSelectors.currentRefinedValues %>',
                            clearAll: 'after',
                            templates: {
                                header: <%= addTemplate(currentRefinedValuesHeaderTemplate) %>,
                                clearAll: <%= addTemplate(currentRefinedValuesClearAllTemplate) %>
                            },
                            cssClasses: <%= addClassNamesFor('currentRefinedValues', {}) %>
                        })
                    );
                <% } %>

                <% if (showFulltextFilter) { %>
                    search.addWidget(
                        persooInstantSearch.widgets.searchBox({
                            container: '<%= widgetContainerSelectors.fulltextFilter %>',
                            placeholder: '<%= fulltextFilterPlaceholder %>',
                            cssClasses: <%= addClassNamesFor('searchBox', {}) %>
                        })
                    );
                <% } %>

                <% if (showMenu) { %>
                    search.addWidget(
                        persooInstantSearch.widgets.menu({
                            container: '<%= widgetContainerSelectors.menu %>',
                            attributeName: '<%= menuAttributeName %>',
                            limit: '<%= menuLimit %>',
                            <%= addCollapsibleOption(menuCollapsible, menuCollapsed) %>,
                            templates: {
                                header: <%= addTemplate(menuHeaderTemplate) %>
                            },
                            cssClasses: <%= addClassNamesFor('menu', {}) %>
                        })
                    );
                <% } %>
                <% if (showHierarchicalMenu) { %>
                    search.addWidget(
                        persooInstantSearch.widgets.hierarchicalMenu({
                            container: '<%= widgetContainerSelectors.hierarchicalMenu %>',
                            <% var hierarchicalMenuParsedAttrNames = hierarchicalMenuAttributeNames.split(/\s*,\s*/); %>
                            attributes: <%= JSON.stringify(hierarchicalMenuParsedAttrNames) %>,
                            limit: '<%= hierarchicalMenuLimit %>',
                            <%= addCollapsibleOption(hierarchicalMenuCollapsible, hierarchicalMenuCollapsed) %>,
                            templates: {
                                header: <%= addTemplate(hierarchicalMenuHeaderTemplate) %>
                            },
                            cssClasses: <%= addClassNamesFor('hierarchicalMenu', {}) %>
                        })
                    );
                <% } %>

                <% if (showRefinementList1) { %>
                    search.addWidget(
                        persooInstantSearch.widgets.refinementList({
                            container: '<%= widgetContainerSelectors.refinementList1 %>',
                            attributeName: '<%= refinementList1AttributeName %>',
                            operator: 'or',
                            templates: {
                                header: <%= addTemplate(refinementList1HeaderTemplate) %>
                            },
                            limit: <%= refinementList1Limit %>,
                            <%= addShowMoreOption(refinementList1ShowMore, refinementList1ShowMoreLimit) %>,
                            <%= addCollapsibleOption(refinementList1Collapsible, refinementList1Collapsed) %>,
                            cssClasses: <%= addClassNamesFor('refinementList', {}) %>
                        })
                    );
                <% } %>

                <% if (showRefinementList2) { %>
                    search.addWidget(
                        persooInstantSearch.widgets.refinementList({
                            container: '<%= widgetContainerSelectors.refinementList2 %>',
                            attributeName: '<%= refinementList2AttributeName %>',
                            operator: 'or',
                            templates: {
                                header: <%= addTemplate(refinementList2HeaderTemplate) %>
                            },
                            limit: <%= refinementList2Limit %>,
                            <%= addShowMoreOption(refinementList2ShowMore, refinementList2ShowMoreLimit) %>,
                            <%= addCollapsibleOption(refinementList2Collapsible, refinementList2Collapsed) %>,
                            cssClasses: <%= addClassNamesFor('refinementList', {}) %>
                        })
                    );
                <% } %>

                <% if (showRefinementList3) { %>
                    search.addWidget(
                        persooInstantSearch.widgets.refinementList({
                            container: '<%= widgetContainerSelectors.refinementList3 %>',
                            attributeName: '<%= refinementList3AttributeName %>',
                            operator: 'or',
                            templates: {
                                header: <%= addTemplate(refinementList3HeaderTemplate) %>
                            },
                            limit: <%= refinementList3Limit %>,
                            <%= addShowMoreOption(refinementList3ShowMore, refinementList3ShowMoreLimit) %>,
                            <%= addCollapsibleOption(refinementList3Collapsible, refinementList3Collapsed) %>,
                            cssClasses: <%= addClassNamesFor('refinementList', {}) %>
                        })
                    );
                <% } %>

                search.start();

                function activateSearchBarCross() {
                    var searchBarElem = document.querySelector('.persoo-search-bar--root');
                    var input = searchBarElem.querySelector('input');

                    conditionallyHideClearCross();
                    input.addEventListener('input', conditionallyHideClearCross);
                    searchBarElem.querySelector('.persoo-clear-query').addEventListener('click', function(e) {
                        search.helper.setQuery('').search();
                        conditionallyHideClearCross();
                    });

                    function conditionallyHideClearCross(e) {
                        var crossElem = searchBarElem.querySelector('.persoo-clear-query');
                        crossElem.style.display = input.value ? 'inline' : 'none';
                    }
                }
                activateSearchBarCross();

                <% if (showFulltextFilter && hideOnEmptyInput) { %>
                    function setHiddenClass(elem, isVisible) {
                        if (elem) {
                            if (isVisible) {
                                elem.className = elem.className.replace(/\s*persoo-hidden/g,'');
                            } else {
                                if (!elem.className.indexOf('persoo-hidden') >=0 ) {
                                    elem.className += ' persoo-hidden';
                                }
                            }
                        }
                    }
                    function hideSearchResultsOnEmptyInput() {
                         var inputElem = document.querySelector('<%= widgetContainerSelectors.fulltextFilter %>');
                         var searchResultsElem = document.querySelector('<%= widgetContainerSelectors.searchResults %>');
                         var originalPageContentElem = document.querySelector('<%= widgetContainerSelectors.originalPageContent %>');
                         setHiddenClass(searchResultsElem, inputElem.value);
                         setHiddenClass(originalPageContentElem, !inputElem.value);
                    }
                    search.on('render', hideSearchResultsOnEmptyInput);
                    hideSearchResultsOnEmptyInput();
                <% } %>
            }
            function loadScript(url, onloadFn, errorFn) {var d = document; var s=d.createElement("script");
                s.src=url,s.type="text/javascript",s.async=true,s.onerror=errorFn,s.onload=onloadFn;
                d.getElementsByTagName("head")[0].appendChild(s)};

            var isLibLink = "https://scripts.persoo.cz/shared/instantsearchV1/persooInstantSearch.js";
            loadScript(isLibLink, initInstantSearch, function (){});
        })();
    </script>

    <script type="text/javascript">
        <%= customJS %>
    </script>
</div>
